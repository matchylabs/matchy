name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  preflight:
    name: Preflight Checks
    runs-on: namespace-profile-linux-amd64
    steps:
      - uses: namespacelabs/nscloud-checkout-action@v8
      
      - name: Setup Rust
        uses: ./.github/actions/setup-rust
      
      - name: Check formatting
        run: cargo fmt --all -- --check
      
      - name: Run clippy with dead code check
        run: cargo clippy --lib --bins -- -D warnings -D dead_code

  test:
    name: Test
    runs-on: ${{ matrix.os }}
    needs: [preflight]
    strategy:
      matrix:
        os: [namespace-profile-linux-amd64, namespace-profile-linux-arm64, namespace-profile-macos-26-1, namespace-profile-windows-amd64]
    steps:
      # Namespace runners: use cached checkout
      - name: Checkout (Namespace)
        if: ${{ !contains(matrix.os, 'windows') }}
        uses: namespacelabs/nscloud-checkout-action@v8
      
      # Windows: use standard checkout
      - name: Checkout (Windows)
        if: ${{ contains(matrix.os, 'windows') }}
        uses: actions/checkout@v6
      
      # Namespace runners: use composite action
      - name: Setup Rust (Namespace)
        if: ${{ !contains(matrix.os, 'windows') }}
        uses: ./.github/actions/setup-rust
      
      # Windows: fall back to GitHub Actions cache + manual setup
      - name: Cache cargo (Windows)
        if: ${{ contains(matrix.os, 'windows') }}
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Install Rust (Windows)
        if: ${{ contains(matrix.os, 'windows') }}
        uses: dtolnay/rust-toolchain@stable
      
      - name: Build
        run: cargo build --verbose
      
      - name: Run tests (lib/bins/tests only; skip doctests; enable bench-internal for test needs)
        run: cargo test --verbose --lib --bins --tests --features bench-internal
      
      - name: Run integration tests explicitly
        run: cargo test --test integration_tests --verbose --features bench-internal
      
      - name: Run examples (public API only)
        run: cargo run --example cache_demo

  docs:
    name: Documentation
    runs-on: namespace-profile-linux-amd64
    needs: [preflight]
    steps:
      - uses: namespacelabs/nscloud-checkout-action@v8
      
      - name: Setup Rust
        uses: ./.github/actions/setup-rust
      
      - name: Check documentation
        run: cargo doc --no-deps --document-private-items
        env:
          RUSTDOCFLAGS: -D warnings

  # bench:
  #   name: Benchmarks
  #   runs-on: namespace-profile-linux-amd64
  #   needs: [preflight]
  #   steps:
  #     - uses: actions/checkout@v6
  #     
  #     - name: Install Rust
  #       uses: dtolnay/rust-toolchain@stable
  #     
  #     - name: Cache cargo build
  #       uses: actions/cache@v4
  #       with:
  #         path: target
  #         key: ${{ runner.os }}-cargo-bench
  #     
  #     - name: Compile benchmarks (bench-internal)
  #       run: cargo bench --no-run --features bench-internal
  #     
  #     - name: Run benchmark smoke test (bench-internal)
  #       run: cargo bench --features bench-internal -- --test

  coverage:
    name: Code Coverage
    # Only run on main branch pushes or release PRs (expensive job)
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && startsWith(github.head_ref, 'release/'))
    runs-on: namespace-profile-linux-amd64
    needs: [preflight]
    steps:
      - uses: namespacelabs/nscloud-checkout-action@v8
      
      - name: Setup Rust
        uses: ./.github/actions/setup-rust
      
      - name: Install tarpaulin
        uses: taiki-e/install-action@cargo-tarpaulin
      
      - name: Generate coverage (no bench features)
        run: cargo tarpaulin --verbose --workspace --timeout 120 --out xml --engine llvm
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./cobertura.xml
          fail_ci_if_error: false

  # freebsd:
  #   name: FreeBSD Test
  #   runs-on: ubuntu-latest  # Needs full VM support, not available on namespace runners
  #   needs: [preflight]
  #   steps:
  #     - uses: actions/checkout@v6
  #     
  #     - name: Test on FreeBSD
  #       uses: vmactions/freebsd-vm@v1
  #       with:
  #         release: '14.1'
  #         usesh: true
  #         prepare: |
  #           pkg install -y rust
  #           cargo install cbindgen
  #         run: |
  #           cargo build --verbose
  #           cargo test --verbose
  #           cargo test --test integration_tests --verbose
  #           echo "FreeBSD tests successful!"

  security:
    name: Security Audit
    # Only run on main branch pushes or release PRs
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && startsWith(github.head_ref, 'release/'))
    runs-on: namespace-profile-linux-amd64
    needs: [preflight]
    steps:
      - uses: namespacelabs/nscloud-checkout-action@v8
      
      - name: Run security audit
        uses: rustsec/audit-check@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

  wasm:
    name: Check WASM
    # Only run on main branch pushes or release PRs
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && startsWith(github.head_ref, 'release/'))
    runs-on: namespace-profile-linux-amd64
    needs: [preflight]
    steps:
      - uses: namespacelabs/nscloud-checkout-action@v8

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          targets: wasm32-unknown-unknown, wasm32-wasip1

      - name: Check WASM compilation
        run: cargo check -p matchy-wasm --target wasm32-unknown-unknown

      - name: Check WASI compilation
        run: cargo check -p matchy --target wasm32-wasip1 --no-default-features
